import React, { useState, useEffect } from "react";
import {
  Box,
  Grid,
  Card,
  CardHeader,
  CardContent,
  Divider,
  TextField,
  Typography,
  Autocomplete,
  Button,
  IconButton,
  Paper,
  Stack,
} from "@mui/material";
import PinDropTwoToneIcon from "@mui/icons-material/PinDropTwoTone";
import ContactEmergencyIcon from "@mui/icons-material/ContactEmergency";
import { useFormik } from "formik";
import * as Yup from "yup";
import { DemoContainer } from "@mui/x-date-pickers/internals/demo";
import { AdapterDayjs } from "@mui/x-date-pickers/AdapterDayjs";
import { LocalizationProvider } from "@mui/x-date-pickers/LocalizationProvider";
import { DatePicker } from "@mui/x-date-pickers/DatePicker";
import { fetenterpriseType } from "../../../services/dropdownService";
import {
  UpdateLegaldocuments,
  downloadDeclarationHoD,
  downloadConsentLetterPSU,
  fetchLegaldocuments,
} from "../../../services/employerLegalDoc";
import dayjs from "dayjs";
import { useSelector } from "react-redux";
import {
  Download as DownloadIcon,
  UploadFile as UploadFileIcon,
} from "@mui/icons-material";
import { useSnackbar } from "../../../components/Snackbar";
import SendIcon from "@mui/icons-material/Send";
import DownloadButton from "../../../components/downloadfile";

// Helper: Map API docTypeId to uploadedFiles keys
const docTypeIdToKey = {
  4: "certificateOfIncorporation",
  12: "gst",
  2: "epfCertificate",
  14: "turnoverDocumentsFy2",
  7: "payrollDocuments",
  8: "pfReturnDocuments",
  6: "turnoverDocumentsFy1",
  15: "turnoverDocumentsFy3",
  // Add more mappings as needed
};

const LegalDocument = ({ goToNextTab, goToBackTab, markTabAsCompleted }) => {
  const { showSnackbar } = useSnackbar();
  const [enterpriseType, setEnterpriseType] = useState([]);
  const organizationType = "Bihar Registered Companies";
  const { userInfo } = useSelector((state) => state.auth);
  const orgTypeId = userInfo?.userDetails?.organizationType?.id;

  // This state will store fetched data from API for "back" functionality
  const [apiData, setApiData] = useState(null);

  // Uploaded files state (for new uploads)
  const [uploadedFiles, setUploadedFiles] = useState({
    gst: null,
    esicCertificate: null,
    epfCertificate: null,
    declarationForm: null,
    certificateOfIncorporation: null,
    udyogAadhaarCertificate: null,
    turnoverDocumentsFy1: null,
    turnoverDocumentsFy2: null,
    turnoverDocumentsFy3: null,
    payrollDocuments: null,
    pfReturnDocuments: null,
    consentLetterPSU: null,
    declarationHoD: null,
  });

  // Load dropdowns and API data on mount
  useEffect(() => {
    const loadenterpriseType = async () => {
      try {
        const data = await fetenterpriseType();
        setEnterpriseType(data);
      } catch (err) {
        console.error("Failed to fetch enterprise dropdown", err);
      }
    };

    const fetchUploadedDocumentsDetails = async () => {
      try {
        const data = await fetchLegaldocuments();
        setApiData(data?.result || null);
      } catch (err) {
        console.error("Failed to fetch Data", err);
      }
    };

    loadenterpriseType();
    fetchUploadedDocumentsDetails();
  }, []);

  // Helper: Find dropdown option by ID
  function findEnterpriseTypeOptionById(id) {
    if (!id || !enterpriseType?.length) return null;
    return enterpriseType.find((item) => item.id === id) ?? null;
  }

  // When API data arrives, update Formik initial values and uploadedFiles state
  useEffect(() => {
    if (!apiData) return;

    // Prepare mapped initial values from API result
    const initialValuesFromApi = {
      IncorporationCertificateNumber: apiData.incorporationCertNo || "",
      RegisteredAddress: apiData.incorporationRegisteredAddress || "",
      DateofIncorporation: apiData.dateOfIncorporation || "",
      UdyogCertificateNumber: apiData.udyogAadhaarNo || "",
      TypeofEnterprise: findEnterpriseTypeOptionById(apiData.enterpriseType), // assumes dropdown values are {id, label}
      DateofRegistration: apiData.udyogAadhaarRegDate || "",
      epfNumber: apiData.epfNo || "",
      RegisteredAuthority: apiData.epfRegisterAuthority || "",
      esicNumber: apiData.esicNo || "",
      esicAuthority: apiData.esicAuthority || "",
      TurnoverFY_2024_25: apiData.turnoverFY1 || "",
      TurnoverFY_2023_24: apiData.turnoverFY2 || "",
      TurnoverFY_2022_23: apiData.turnoverFY3 || "",
      Payroll: apiData.payroll ?? "",
      PF_Return_Last_3_Months: apiData.pfReturn3Mon ?? "",
      // File names for display
      gstFileName: "",
      certificateOfIncorporationFileName: "",
      udyogAadhaarCertificateFileName: "",
      epfCertificateFileName: "",
      esicCertificateFileName: "",
      turnoverDocumentsFy1FileName: "",
      turnoverDocumentsFy2FileName: "",
      turnoverDocumentsFy3FileName: "",
      payrollDocumentsFileName: "",
      pfReturnDocumentsFileName: "",
      consentLetterPSUFileName: "",
      declarationHoDFileName: "",
      declarationFormFileName: "",
    };

    // Set filenames from documents array
    if (apiData.documents && Array.isArray(apiData.documents)) {
      apiData.documents.forEach((doc) => {
        const key = docTypeIdToKey[doc.docTypeId];
        if (key) {
          initialValuesFromApi[`${key}FileName`] = doc.originalFilename || doc.filename || "";
        }
      });
    }

    // Set Formik values
    formik.setValues(initialValuesFromApi);

    // Prepare uploadedFiles for display (no file object, but display name + filename)
    const filesState = { ...uploadedFiles };
    if (apiData.documents && Array.isArray(apiData.documents)) {
      apiData.documents.forEach((doc) => {
        const key = docTypeIdToKey[doc.docTypeId];
        if (key) {
          // For download later, store docTypeId and docTypeName
          filesState[key] = {
            url: "", // will be used for download link in future
            name: doc.docTypeName + " (" + (doc.originalFilename || doc.filename) + ")",
            docTypeId: doc.docTypeId,
            filename: doc.filename,
            originalFilename: doc.originalFilename,
            docTypeName: doc.docTypeName,
          };
        }
      });
    }
    setUploadedFiles(filesState);
    // eslint-disable-next-line
  }, [apiData, enterpriseType]);

  // File upload handler (overwrites only the file for the field)
  const handleFileUpload = (fieldKey, file) => {
    if (!file) return;
    const objectURL = URL.createObjectURL(file);

    setUploadedFiles((prev) => ({
      ...prev,
      [fieldKey]: { file, url: objectURL, name: file.name },
    }));

    formik.setFieldValue(`${fieldKey}FileName`, file.name);
  };

  // For file link, display name; if no file, show "No file chosen"
  const renderFileLink = (fileObj) => {
    return fileObj && fileObj.name ? (
      <span>{fileObj.name}</span>
    ) : (
      "No file chosen"
    );
  };

  const getValidationSchema = (orgTypeId) => {
    const base = {
      IncorporationCertificateNumber: Yup.string().required(
        "Incorporation Certificate Number is required"
      ),
      RegisteredAddress: Yup.string().required("Registered Address is required"),
      DateofIncorporation: Yup.string().required(
        "Date of Incorporation is required"
      ),

      epfNumber: Yup.string().required("EPF Number is required"),
      RegisteredAuthority: Yup.string().required(
        "Registered Authority is required"
      ),

      TurnoverFY_2024_25: Yup.string().required(
        "Turnover for FY 2024-25 is required"
      ),
      TurnoverFY_2023_24: Yup.string().required(
        "Turnover for FY 2023-24 is required"
      ),
      TurnoverFY_2022_23: Yup.string().required(
        "Turnover for FY 2022-23 is required"
      ),
    };

    switch (orgTypeId) {
      case 1:
        return Yup.object({
          ...base,
          UdyogCertificateNumber: Yup.string().required(
            "Udyog Aadhaar Number is required"
          ),
          TypeofEnterprise: Yup.object().required(
            "Type of Enterprise is required"
          ),
          DateofRegistration: Yup.string().required(
            "Udyog Aadhaar Registration Date is required"
          ),
        });

      case 2:
        return Yup.object({
          ...base,
          Payroll: Yup.string().required("Payroll is required"),
          PF_Return_Last_3_Months: Yup.string().required(
            "PF Return for last 3 months is required"
          ),
        });

      case 3:
        return Yup.object({
          ...base,
          certificateOfIncorporationFileName: Yup.string().required(
            "Certificate of Incorporation is required"
          ),
          consentLetterPSUFileName: Yup.string().required(
            "Consent letter is required"
          ),
        });

      case 4:
        return Yup.object({
          declarationHoDFileName: Yup.string().required(
            "Declaration from HoD is required"
          ),
        });

      default:
        return Yup.object(base);
    }
  };

  // Formik setup
  const formik = useFormik({
    initialValues: {
      IncorporationCertificateNumber: "",
      RegisteredAddress: "",
      DateofIncorporation: "",
      UdyogCertificateNumber: "",
      TypeofEnterprise: null,
      DateofRegistration: "",
      epfNumber: "",
      RegisteredAuthority: "",
      esicNumber: "",
      esicAuthority: "",
      TurnoverFY_2024_25: "",
      TurnoverFY_2023_24: "",
      TurnoverFY_2022_23: "",
      Payroll: "",
      PF_Return_Last_3_Months: "",
      gstFileName: "",
      certificateOfIncorporationFileName: "",
      udyogAadhaarCertificateFileName: "",
      epfCertificateFileName: "",
      esicCertificateFileName: "",
      turnoverDocumentsFy1FileName: "",
      turnoverDocumentsFy2FileName: "",
      turnoverDocumentsFy3FileName: "",
      payrollDocumentsFileName: "",
      pfReturnDocumentsFileName: "",
      consentLetterPSUFileName: "",
      declarationHoDFileName: "",
      declarationFormFileName: "",
    },
    validationSchema: getValidationSchema(orgTypeId),
    onSubmit: async (values) => {
      const formData = new FormData();
      Object.entries(uploadedFiles).forEach(([key, fileObj]) => {
        if (fileObj && fileObj.file) {
          formData.append(key, fileObj.file);
        }
      });

      formData.append(
        "data",
        new Blob(
          [
            JSON.stringify({
              udyogAadhaarNo: values.UdyogCertificateNumber || null,
              udyogAadhaarRegDate: values.DateofRegistration || null,
              enterpriseTypeId: values.TypeofEnterprise?.id ?? null,
              epfNo: values.epfNumber || null,
              epfRegisterAuthority: values.RegisteredAuthority || null,
              esicNo: values.esicNumber || null,
              esicAuthority: values.esicAuthority || null,
              turnoverFY1: values.TurnoverFY_2024_25 || null,
              turnoverFY2: values.TurnoverFY_2023_24 || null,
              turnoverFY3: values.TurnoverFY_2022_23 || null,
              turnoverGreater250Cr: values.TurnoverFY_2024_25
                ? Number(values.TurnoverFY_2024_25) > 250000000
                : null,
              payroll: values.Payroll || null,
              pfReturn3Mon: values.PF_Return_Last_3_Months || null,
              incorporationCertNo:
                values.IncorporationCertificateNumber || null,
              incorporationRegisteredAddress: values.RegisteredAddress || null,
              dateOfIncorporation: values.DateofIncorporation || null,
            }),
          ],
          { type: "application/json" }
        )
      );

      try {
        const response = await UpdateLegaldocuments(formData);
        showSnackbar(response.message || "Form submitted successfully");
        markTabAsCompleted();
        goToNextTab();
      } catch (error) {
        showSnackbar(
          `Error: ${error.response?.data?.message || error.message}`,
          "error"
        );
      }
    },
    enableReinitialize: true,
  });

  return (
    <Box component="form" onSubmit={formik.handleSubmit}>
      <Grid container spacing={3}>
        <Grid size={{ xs: 12, sm: 12 }}>
          <Card sx={{ border: "1px solid #ccc", borderRadius: 2 }}>
            <CardContent>
              {/* ... All UI remains unchanged, just use uploadedFiles and formik as before ... */}
              {/* For file display, now shows the name from API if present, or uploaded name */}
              {/* For download, you can later add a download button using docTypeId/filename */}
              {/* ... */}
              {/* --- Rest of the form code goes here (not shown for brevity, unchanged) --- */}

              <Box
                sx={{
                  display: "flex",
                  justifyContent: "center",
                  gap: 2,
                  mt: 2,
                }}
              >
                <Button
                  onClick={() => goToBackTab()}
                  variant="contained"
                  startIcon={<SendIcon sx={{ transform: "scaleX(-1)" }} />}
                >
                  Back
                </Button>

                <Button
                  type="submit"
                  variant="contained"
                  endIcon={<SendIcon />}
                >
                  Save & Next
                </Button>
              </Box>
            </CardContent>
          </Card>
        </Grid>
      </Grid>
    </Box>
  );
};

export default LegalDocument;
